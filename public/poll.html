<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="" />
        <meta name="author" content="" />

        <title>WebApp Votacions BEST Barcelona</title>

        <!-- Bootstrap Core CSS -->
        <link
            href="../vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />

        <!-- MetisMenu CSS -->
        <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet" />

        <!-- Custom CSS -->
        <link href="../dist/css/sb-admin-2.css" rel="stylesheet" />

        <!-- Morris Charts CSS -->
        <!--<link href="../vendor/morrisjs/morris.css" rel="stylesheet">-->

        <!-- Custom Fonts -->
        <link
            href="../vendor/font-awesome/css/fontawesome.min.css"
            rel="stylesheet"
            type="text/css"
        />
        <link
            href="../vendor/font-awesome/css/solid.min.css"
            rel="stylesheet"
            type="text/css"
        />

        <link rel="icon" type="image/png" href="../images/BEST_logomark.png" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        <div id="wrapper">
            <!-- Navigation -->
            <div id="navbar"></div>

            <div id="page-wrapper">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header" id="pollName"></h1>
                    </div>
                </div>
                <div class="row">
                    <h3 id="pollInfo"></h3>
                    <div class="col-lg-5" id="pollOptions"></div>
                </div>
                <div class="row">
                    <div
                        class="col-lg-5"
                        id="buttons"
                        style="text-align: right"
                    >
                        <select id="voter" name="Voting as"></select>
                        <button
                            type="button"
                            id="vote"
                            class="btn btn-primary btn-lg"
                            style="margin: 10px"
                        >
                            Send vote
                        </button>
                    </div>
                </div>

                <p id="text"></p>
            </div>
            <!-- /#page-wrapper -->
        </div>
        <!-- /#wrapper -->

        <!-- jQuery -->
        <script src="../vendor/jquery/jquery.min.js"></script>

        <script src="../vendor/jqueryui/jquery-ui.min.js"></script>

        <script src="../vendor/jqueryui/jquery.ui.touch-punch.min.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

        <!-- Metis Menu Plugin JavaScript -->
        <script src="../vendor/metisMenu/metisMenu.min.js"></script>

        <!-- Morris Charts JavaScript -->
        <!--<script src="../vendor/raphael/raphael.min.js"></script>-->
        <!--<script src="../vendor/morrisjs/morris.min.js"></script>-->
        <!--<script src="../data/morris-data.js"></script>-->

        <!-- Custom Theme JavaScript -->
        <script src="../dist/js/sb-admin-2.js"></script>
        <!--
    <script>
      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
          console.log('User signed out.');
        });
      }
    </script>
-->

        <script src="js/navbar.js"></script>
        <script>
            pollId = gup('id');

            $('#navbar').load('navbar.html', function () {
                var xhrAux = new XMLHttpRequest();
                xhrAux.open('GET', '/api/users/current');
                xhrAux.setRequestHeader(
                    'Content-Type',
                    'application/x-www-form-urlencoded',
                );
                xhrAux.onload = function () {
                    const user = JSON.parse(xhrAux.response);
                    initNavBar(user);
                    var xhrDelegations = new XMLHttpRequest();
                    xhrDelegations.open('GET', '/api/delegations/');
                    xhrDelegations.onload = function () {
                        if (xhrDelegations.status != 200) {
                            error(
                                'Error' + xhrDelegations.status,
                                xhrDelegations.responseText,
                                goHome,
                            );
                            return 0;
                        }
                        var users = JSON.parse(xhrDelegations.response);
                        console.log(JSON.parse(xhrAux.response));
                        var select = document.getElementById('voter');
                        for (var i = 0; i < users.length; ++i) {
                            var option = document.createElement('option');
                            option.text = users[i].name;
                            option.value = users[i].userId;
                            select.add(option, 0);
                        }
                        var option = document.createElement('option');
                        option.text = user.web.name;
                        option.value = 'Me';
                        select.add(option, 0);
                    };
                    xhrDelegations.send();

                    var urlReq = '/api/polls/' + pollId;
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', urlReq);
                    xhr.setRequestHeader(
                        'Content-Type',
                        'application/x-www-form-urlencoded',
                    );
                    xhr.onload = function () {
                        //                $('#text').append(xhr.responseText)
                        if (xhr.status != 200) {
                            error(
                                'Error' + xhr.status,
                                xhr.responseText,
                                goHome,
                            );
                            return 0;
                        }
                        var poll = JSON.parse(xhr.responseText);
                        window.results = poll;
                        if (poll.state != undefined && poll.state != 'open') {
                            error('Error', 'Poll is not open', function () {
                                window.location =
                                    DOMAIN + '/results.html?id=' + pollId;
                            });
                            return 0;
                        }

                        var state = poll.state;
                        if (state == 'open') $('#selectState').val('Open');
                        if (state == 'closed_hidden')
                            $('#selectState').val('Closed hidden');
                        if (state == 'closed') $('#selectState').val('Closed');
                        var pollOptions = poll.pollOptions;
                        //poll.pollOption='Bernat' //DEBUG
                        //$('#text').append(selectedOption) //DEBUG
                        var pollName = poll.pollName;
                        $('title').text(pollName);
                        if (poll.isPrivate == 'true') {
                            pollName += "    <i class='fa fa-lock'></i>";
                        } else {
                            pollName += "    <i class='fa fa-unlock'></i>";
                        }
                        $('#pollName').append(pollName); //Add pollName to html

                        if (poll.isPriority == 'true') {
                            console.log(poll);
                            $('#pollInfo').append(
                                'This is a priority vote, please sort the following options:',
                            );

                            if (poll.pollOption.length > 0) {
                                pollOptions = JSON.parse(poll.pollOption);
                            }
                            for (i in pollOptions) {
                                //For all poll options
                                pollOption = pollOptions[i];
                                var button = $(
                                    '<div class="btn btn-default btn-lg btn-block no-focus    " style="text-align: left"></div>',
                                ) //create button for this poll option
                                    .append(' ' + pollOption) //add option name to button
                                    .attr('pos', i); //save position of this polloption in the button
                                $('#pollOptions').append(button); //we add the button to the list of buttons
                            }
                            $('#pollOptions').sortable();
                            vote = function (delegation) {
                                $(this).blur(); //loose focus
                                var xhr2 = new XMLHttpRequest();
                                var voterOptions = document.getElementById(
                                    'voter',
                                );
                                if (voter.value == 'Me') {
                                    xhr2.open('POST', '/api/votes');
                                } else {
                                    xhr2.open('POST', '/api/votes/' + value);
                                }
                                xhr2.setRequestHeader(
                                    'Content-Type',
                                    'application/json',
                                );
                                xhr2.onload = function () {
                                    success(
                                        'Success',
                                        'Vote added successfully',
                                        location.reload,
                                    );
                                };
                                option = $.map(
                                    $('#pollOptions').children(),
                                    function (a) {
                                        return a.innerText;
                                    },
                                );
                                const vote = {
                                    pollId,
                                    option,
                                };
                                xhr2.send(JSON.stringify(vote));
                            };
                            $('#vote').click(function () {
                                vote(false);
                            });
                            $(':root').keydown(function (e) {
                                if (e.keyCode == 13) {
                                    //enter
                                    $('#vote').click();
                                }
                            });
                        } else {
                            user.web.name;
                            var xhrVoteGet = new XMLHttpRequest();
                            xhrVoteGet.open(
                                'GET',
                                '/api/votes/' +
                                    user.web.userId +
                                    '/' +
                                    poll._id,
                            );
                            xhrVoteGet.setRequestHeader(
                                'Content-Type',
                                'application/x-www-form-urlencoded',
                            );
                            xhrVoteGet.onload = function () {
                                var opt = JSON.parse(
                                    xhrVoteGet.response,
                                ).option;
                                console.log(opt)
                                var selectedOption = pollOptions.indexOf(JSON.parse(
                                    xhrVoteGet.response,
                                ).option[0]);
                                console.log(selectedOption)
                                for (i in pollOptions) {
                                    //For all poll options
                                    pollOption = pollOptions[i];
                                    var button = $(
                                        '<button type="button" class="btn btn-default btn-lg btn-block no-focus    " style="text-align: left"><div class="btn btn-default btn-circle"><i class=""></i></div></button>',
                                    ) //create button for this poll option
                                        .append(' ' + pollOption) //add option name to button
                                        .attr('pos', i) //save position of this polloption in the button
                                        .click(function () {
                                            //What happens if we click this button?
                                            $(this).blur(); //remove focus
                                            ind = $(this).attr('pos'); //get position of this clicked option from the html
                                            if (selectedOption != ind) {
                                                //do nothing if it's already selected
                                                $(this)
                                                    .removeClass('btn-default')
                                                    .addClass('btn-primary'); //change color to primary
                                                $(this)
                                                    .find('i')
                                                    .addClass('fa fa-check'); //add check icon
                                                if (selectedOption != -1) {
                                                    //if there was another selected option
                                                    $(this)
                                                        .parent()
                                                        .find(
                                                            "[pos='" +
                                                                selectedOption +
                                                                "']",
                                                        ) //find the previously selected option
                                                        .removeClass(
                                                            'btn-primary',
                                                        )
                                                        .addClass('btn-default') //change its color
                                                        .find('i')
                                                        .removeClass(
                                                            'fa fa-check',
                                                        ); //remove its check icon
                                                }
                                                selectedOption = ind; //update selected option variable
                                            }
                                        });
                                    if (i == selectedOption) {
                                        //If button we are going to add was already selected
                                        button
                                            .removeClass('btn-default')
                                            .addClass('btn-primary') //change its color
                                            .find('i')
                                            .addClass('fa fa-check'); //add check icon
                                    }
                                    $('#pollOptions').append(button); //we add the button to the list of buttons
                                }
                                vote = function (delegation) {
                                    $(this).blur(); //loose focus
                                    if (selectedOption == -1) {
                                        error('Error', 'No option selected');
                                    } else {
                                        var xhr2 = new XMLHttpRequest();
                                        var voterOptions = document.getElementById(
                                            'voter',
                                        );
                                        if (voter.value == 'Me') {
                                            xhr2.open('POST', '/api/votes');
                                        } else {
                                            xhr2.open(
                                                'POST',
                                                '/api/votes/' + value,
                                            );
                                        }
                                        xhr2.setRequestHeader(
                                            'Content-Type',
                                            'application/json',
                                        );
                                        xhr2.onload = function () {
                                            success(
                                                'Success',
                                                'Vote added successfully',
                                                location.reload,
                                            );
                                        };
                                        const vote = {
                                            pollId,
                                            option: [
                                                pollOptions[selectedOption],
                                            ],
                                        };
                                        xhr2.send(JSON.stringify(vote));
                                    }
                                };
                                $('#vote').click(function () {
                                    vote(false);
                                });
                                $(':root').keydown(function (e) {
                                    //alert(e.keyCode)
                                    if (e.keyCode >= 48 && e.keyCode <= 57) {
                                        //number
                                        var pressedNumber = e.keyCode - 48;
                                        var buttonToClick = $(
                                            '#pollOptions',
                                        ).find(
                                            'button:nth-child(' +
                                                pressedNumber +
                                                ')',
                                        );
                                        if (buttonToClick.exists())
                                            buttonToClick.click();
                                    }
                                    if (e.keyCode == 13) {
                                        //enter
                                        $('#vote').click();
                                    }
                                });
                            };
                            xhrVoteGet.send();
                        } // BITG
                    };
                    xhr.send();
                };
                xhrAux.send();
            }); // BIG
            function goHome() {
                window.location = DOMAIN + '/index.html';
            }
        </script>
    </body>
</html>
