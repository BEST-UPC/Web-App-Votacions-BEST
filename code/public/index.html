<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>WebApp Votacions BEST Barcelona</title>

  <!-- Bootstrap Core CSS -->
  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link href="../vendor/datatables-plugins/dataTables.bootstrap.css" rel="stylesheet">

  <!-- MetisMenu CSS -->
  <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

</head>

<body>

  <div id="wrapper">

    <div id="navbar"></div>

    <div id="page-wrapper">
      <!-- <div class="table-responsive"> -->
      <div style="padding: 10px"> <!-- per deixar un espai -->
      </div>
      <table class="table display" id="pollListTable"  cellspacing="0" width="100%">
        <thead>
          <tr>
            <th>Name</th>
            <th>Deadline</th>
          </tr>
        </thead>
        <tbody id="pollListContent">
        </tbody>
      </table>
      <!-- </div> -->
    </div>
    <!-- /#page-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- jQuery -->
  <script src="../vendor/jquery/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

  <!-- Metis Menu Plugin JavaScript -->
  <script src="../vendor/metisMenu/metisMenu.min.js"></script>

  <!-- DataTables JavaScript -->
  <script src="../vendor/datatables/js/jquery.dataTables.min.js"></script>
  <script src="../vendor/datatables-plugins/dataTables.bootstrap.min.js"></script>
  <script src="../vendor/datatables-responsive/dataTables.responsive.js"></script>

  <!-- Custom Theme JavaScript -->
  <script src="../dist/js/sb-admin-2.js"></script>

  <script src="js/cookie.js">  </script>
  <script>
    if (getCookie("idtoken") == ""){
      window.location = "http://localhost:3000/login.html";
    }
    else{
      console.log();
      //alert(getCookie("idtoken"))
    }
  </script>

  <a href="#" onclick="signOut();">Sign out</a>
  <script>
    function signOut() {
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
    }
  </script>

  <script src="js/navbar.js">  </script>
  <script>

    $("#navbar").load("navbar.html",function(){
      initNavBar(JSON.parse(getCookie("profile")))
    });
    id_token = getCookie("idtoken")
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://localhost:3000/getPolls');
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
      result = JSON.parse(xhr.responseText)
      if (result.status!='0'){
        //alert('RESPONSETEXT: '+xhr.responseText)
        window.location="http://localhost:3000/login.html"
        return 0
      }
      pollList=result.polls
      for(i in pollList){
        //alert(JSON.stringify(pollList[i]))
        for (var j=0; j<100; j++){
          poll=pollList[i]
          var id=poll._id
          var name=poll.pollName+' '+j
          var date_ms = poll.pollDeadline*1000+j*1000*60*60*10*24-58*365*24*60*60*1000
          //crea una nova fila amb el nom i la deadline
          var row = $('<tr><td>'+name+'</td><td>'+date_ms.toString()+'</td></tr>')
              .attr('id','poll'+id) //afegeix link a la fila
              .click(function(){
                window.location = 'http://localhost:3000/poll.html?id='+$(this).attr('id').substr(4)
              })
              .css('background-color',(poll.pollOption==''?'White':'#B7E797'))//fica blanc o verd depenent de si has votat o no
          $('#pollListContent').append(row) //afegeix fila a la taula
        }
      }
      
      var table = $('#pollListTable').DataTable({
        "order": [[1,"desc"]],//ordena per DL
        "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
          //canvia la data a un string, no es fa abans perque aixi quan li dones a ordenar ho fa per els milisegons i no per el string de la data
          var date=new Date(parseInt(aData[1]))
          $('td:eq(1)', nRow).html(date.toLocaleString())
        }
      })
    }
    xhr.send('idtoken=' + id_token);
  </script>

</body>

</html>
